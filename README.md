# Cloudflare Lyrics Fetcher Worker

This Cloudflare Worker fetches song lyrics by utilizing the YouTube API (for metadata from video IDs) and the Musixmatch
API (for actual lyrics). It's designed to infer song details from a YouTube video ID and then retrieve corresponding
lyrics, with an option for enhanced, word-by-word synchronized lyrics.

## Features

* **YouTube Video ID Input**: Primarily uses a YouTube video ID to identify a song.
* **Metadata Extraction**: Fetches video details from the YouTube API to determine song title, artist, album (if
  possible), and duration.
* **Musixmatch Integration**: Communicates with the Musixmatch API to find and retrieve lyrics.
* **LRC Format Lyrics**: Provides lyrics in the standard LRC (timed lyrics) format.
* **Enhanced Word-by-Word Sync**: Offers an "enhanced" mode that attempts to provide more granular, word-by-word
  synchronized lyrics from Musixmatch's "richsync" feature. This includes a timestamp alignment process by comparing
  with standard LRC timings.
* **Caching**: Implements multiple layers of caching (YouTube API responses, Musixmatch API responses, final lyrics
  responses) to improve performance and reduce external API calls.

## How It Works

When a request is made to the worker:

1. **Request Handling (`index.ts`)**: The main worker script receives the incoming HTTP request. It handles `OPTIONS`
   requests for CORS preflight.
2. **Parameter Processing (`GetLyrics.ts`)**:
    * The core logic resides in `GetLyrics.ts`. It first checks a cache for a response to the identical request URL.
    * A `videoId` (YouTube Video ID) is a **required** query parameter.
    * **YouTube Metadata Fetch**: Using the `videoId` and a `GOOGLE_API_KEY` (configured in `wrangler.toml`), it queries
      the Google YouTube Data API v3 for video details (title, description, duration, channel title). These API
      responses are cached.
    * **Song Detail Inference**: It attempts to parse the song title, artist, and album from the YouTube video's
      metadata. It's only works with videos "Auto-generated by YouTube." (These are the songs uploaded by labels to
      YouTube)
    * If essential song details (song title and artist) cannot be determined, it returns a 400 error if they aren't
      provided in the API call.
3. **Musixmatch API Interaction (`Musixmatch.ts`)**:
    * The `Musixmatch.ts` class manages all communication with the Musixmatch API.
    * **Token Management**: It handles the acquisition and refreshing of a `usertoken` required for Musixmatch API
      calls. Tokens and API responses are cached. It also manages cookies returned by Musixmatch.
    * **Track Matching**: It searches for the track on Musixmatch using the artist, song, and album information (derived
      from YouTube metadata or provided as optional query parameters).
    * **Lyric Fetching**:
        * If the `enhanced=true` query parameter is present and Musixmatch has "richsync" (word-by-word) data for the
          track, it fetches this data. It also fetches the standard LRC. An alignment process using `diffArrays`
          compares character sequences and timings to calculate an `[offset:...]` for the richsync LRC, aiming for
          better accuracy.
        * If `enhanced=false` or richsync is unavailable, but standard LRC subtitles are available, it fetches those.
        * If no lyrics are found, the lyrics field in the response will be `null`.
4. **Response Generation (`GetLyrics.ts` & `index.ts`)**:
    * A JSON response is constructed containing the determined song `artist`, `song` title, `album` (if
      found), `duration`, the `videoId`, the original YouTube `description` (if relevant), the fetched `lyrics` (as an
      LRC formatted string or `null`), and `debugInfo` (which can include lyric matching statistics if enhanced mode was
      used).
    * This final response is cached. Responses containing lyrics are cached for a longer duration (e.g., 7 days) than
      responses without lyrics (e.g., 10 minutes).
    * The `index.ts` worker sets appropriate HTTP headers (including `Access-Control-Allow-Origin`) and returns the
      response.
5. **Asynchronous Operations**: The worker uses an `awaitLists` mechanism (a `Set` of Promises) to track asynchronous
   tasks, primarily cache `put` operations, ensuring they are initiated before the main response is returned.

## API Endpoint

The worker exposes a single GET endpoint.

* **URL**: `/` (relative to your worker's deployed URL)
* **Method**: `GET`

### Query Parameters:

* `videoId` (string, **required**): The YouTube video ID for the song.
    * Example: `dQw4w9WgXcQ`
* `artist` (string, optional): The artist of the song. If provided, it can be used as a fallback or to refine the
  Musixmatch search, though data from the YouTube `videoId` often takes precedence for inference.
* `song` (string, optional): The title of the song. Similar to `artist`, it can be used as a fallback or to refine
  search.
* `album` (string, optional): The album of the song. Used to improve Musixmatch search accuracy.
* `duration` (string, optional): The duration of the song in seconds. Can be inferred from `videoId`.
* `enhanced` (boolean, optional, default: `false`): If set to `true`, the worker will attempt to fetch word-by-word
  synchronized lyrics and perform timestamp alignment.

### Example Request:

`GET /?song=Almost+Forgot&artist=Against+The+Current&duration=208&videoId=Y4gOQSZg5bQ&enhanced=true`

### Success Response (200 OK):

```json
{
    "song": "Almost Forgot",
    "artist": "Against The Current",
    "album": "Past Lives",
    "duration": "209",
    "parsedSongAndArtist": "Almost Forgot · Against The Current",
    "videoId": "Y4gOQSZg5bQ",
    "description": "Provided to YouTube by Fueled By Ramen\n\nAlmost Forgot · Against The Current\n\nPast Lives\n\n℗ 2018 Fueled By Ramen LLC\n\nEditor, Engineer: Andrew Goldsein\nAdditional Guitar: Andrew Goldsein\nAdditional Keyboards: Andrew Goldsein\nAdditional Programming: Andrew Goldsein\nAdditional Vocals: Andrew Goldsein\nProducer: Andrew Goldstein\nMasterer: Chris Gehringer\nVocals: Chrissy Constanza\nGuitar: Dan Gow\nMixer: Neal Avron\nAdditional Vocals: Steph Jones\nBass, Drums: Will Ferri\nWriter: Andrew Goldstein\nWriter: Brittany M. Amaradio\nWriter: Christina Costanza\nWriter: Daniel Gow\nWriter: Stephanie Jones\nWriter: William Ferri\n\nAuto-generated by YouTube.",
    "debugInfo": null,
    "lyrics": "[00:00.24] Oh, oh, oh\n[00:02.51] Oh, oh, oh\n[00:05.07] Oh, oh, oh\n[00:08.29] \n[00:10.52] Sometimes I get confused\n[00:15.02] 'Bout how it all went down\n[00:18.84] When I feel like I miss you\n ..."
}
```

*Error Response (e.g., 400 Bad Request):*
If `videoId` is missing or song/artist cannot be inferred:

```json
{
    "message": "Invalid Video Id"
}
```

or

```json
{
    "message": "A Song wasn't provided and couldn't be inferred"
}
```

## Setup and Local Development

### Prerequisites

- Node.js and npm
- Wrangler CLI (Cloudflare Workers CLI)

### Configuration

1. *Clone the repository*
2. Install dependencies:
    ```Bash
    `npm install`
    ```
3. **Configure Local Development Secrets (`.dev.vars`)**:
   For local development using `wrangler dev`, secrets should be placed in a `.dev.vars` file in the root directory of
   your project. This file should **not** be committed to version control.

   Create a file named `.dev.vars` in your project root and add your Google API Key:
   ```ini
   GOOGLE_API_KEY="YOUR_GOOGLE_API_KEY_HERE"
   ```

   *Obtain a `GOOGLE_API_KEY` from the Google Cloud Console, ensuring the YouTube Data API v3 is enabled for your
   project.*

### Running Locally

1. Start the development server:
    ```Bash
    npm run dev
    ```
   This will typically start a server on `http://localhost:8787`.

2. Test in your browser or with a tool like curl:
   Open `http://localhost:8787/?videoId=YOUR_YOUTUBE_VIDEO_ID`

   For example:
   `http://localhost:8787/?videoId=Qd_Zcmlf4g4&enhanced=true`
